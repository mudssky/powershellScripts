
è¿™ä»½ Cheatsheet å°†å±•ç¤ºå¦‚ä½•æ„å»ºä¸€ä¸ª**å·¥ä¸šçº§ã€é«˜å®¹é”™ã€æ˜“ç»´æŠ¤**çš„ API å®¢æˆ·ç«¯

### ğŸ“‚ æ¨èç›®å½•ç»“æ„

```text
my_integration/
â”œâ”€â”€ .env                    # ç¯å¢ƒå˜é‡
â”œâ”€â”€ config.py               # pydantic-settings é…ç½®ç®¡ç†
â”œâ”€â”€ schemas.py              # pydantic æ•°æ®æ¨¡å‹ (DTO)
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ __init__.py         # æš´éœ²ç»Ÿä¸€å…¥å£
â”‚   â”œâ”€â”€ core.py             # æ ¸å¿ƒåŸºç±» (httpx + tenacity + loguru)
â”‚   â””â”€â”€ services/           # ä¸šåŠ¡æ¥å£æ‹†åˆ†
â”‚       â”œâ”€â”€ user.py
â”‚       â””â”€â”€ order.py
â””â”€â”€ main.py                 # è°ƒç”¨ç¤ºä¾‹
```

---

### 1. é…ç½®å±‚ (`config.py`)

**å·¥å…·**: `pydantic-settings`
**ä½œç”¨**: ä»ç¯å¢ƒå˜é‡åŠ è½½é…ç½®ï¼Œå¼ºç±»å‹æ ¡éªŒï¼Œé¿å… `os.getenv` æ•£è½åœ¨å„å¤„ã€‚

```python
from pydantic_settings import BaseSettings, SettingsConfigDict

class Settings(BaseSettings):
    API_BASE_URL: str = "https://api.example.com"
    API_TIMEOUT: int = 10
    API_TOKEN: str
    
    # è‡ªåŠ¨è¯»å– .env æ–‡ä»¶
    model_config = SettingsConfigDict(env_file=".env", env_file_encoding="utf-8")

settings = Settings()
```

---

### 2. æ•°æ®æ¨¡å‹å±‚ (`schemas.py`)

**å·¥å…·**: `pydantic`
**ä½œç”¨**: å®šä¹‰æ¥å£çš„å…¥å‚å’Œå‡ºå‚ï¼Œæä¾›ä»£ç æç¤ºå’Œè‡ªåŠ¨æ ¡éªŒã€‚

```python
from pydantic import BaseModel, Field, EmailStr
from typing import List, Optional

# --- Response Models ---
class UserDTO(BaseModel):
    id: int
    username: str
    email: Optional[EmailStr] = None

class UserListDTO(BaseModel):
    items: List[UserDTO]
    total: int

# --- Request Models ---
class CreateUserRequest(BaseModel):
    username: str = Field(..., min_length=3)
    password: str
```

---

### 3. æ ¸å¿ƒåŸºç±» (`client/core.py`)

**å·¥å…·**: `httpx`, `tenacity`, `loguru`
**ä½œç”¨**: å°è£…æ‰€æœ‰é€šç”¨é€»è¾‘ï¼ˆé‡è¯•ã€æ—¥å¿—ã€é‰´æƒã€å¼‚å¸¸å¤„ç†ï¼‰ã€‚è¿™æ˜¯ç³»ç»Ÿçš„â€œå¿ƒè„â€ã€‚

```python
import httpx
from tenacity import retry, stop_after_attempt, wait_fixed, retry_if_exception_type
from loguru import logger
from typing import Any, Dict, Type, TypeVar, Optional
from pydantic import BaseModel
from config import settings

T = TypeVar("T", bound=BaseModel)

class BaseClient:
    def __init__(self):
        self.client = httpx.Client(
            base_url=settings.API_BASE_URL,
            timeout=settings.API_TIMEOUT,
            headers={"Authorization": f"Bearer {settings.API_TOKEN}"}
        )

    # --- Tenacity é‡è¯•è£…é¥°å™¨é…ç½® ---
    # ä»…åœ¨å‘ç”Ÿç½‘ç»œé”™è¯¯æˆ–ç‰¹å®š HTTP é”™è¯¯æ—¶é‡è¯•ï¼Œé‡è¯• 3 æ¬¡ï¼Œé—´éš” 2 ç§’
    @retry(
        stop=stop_after_attempt(3),
        wait=wait_fixed(2),
        retry=retry_if_exception_type(httpx.RequestError),
        reraise=True
    )
    def _request(self, method: str, endpoint: str, **kwargs) -> Dict[str, Any]:
        """åº•å±‚è¯·æ±‚å°è£…ï¼šåŒ…å«æ—¥å¿—ã€é‡è¯•ã€é”™è¯¯æŠ›å‡º"""
        url = f"{settings.API_BASE_URL}{endpoint}"
        
        # 1. è®°å½•è¯·æ±‚æ—¥å¿—
        logger.info(f"Requesting: {method} {url} | Params: {kwargs.get('params')} | Body: {kwargs.get('json')}")

        try:
            response = self.client.request(method, endpoint, **kwargs)
            
            # 2. æ£€æŸ¥ HTTP çŠ¶æ€ç  (4xx, 5xx æŠ›å‡ºå¼‚å¸¸)
            response.raise_for_status()
            
            # 3. è®°å½•å“åº”æ—¥å¿— (æˆªæ–­è¿‡é•¿å†…å®¹)
            resp_json = response.json()
            logger.debug(f"Response: {str(resp_json)[:200]}...")
            
            return resp_json

        except httpx.HTTPStatusError as e:
            logger.error(f"HTTP Error {e.response.status_code}: {e.response.text}")
            raise
        except httpx.RequestError as e:
            logger.warning(f"Network Error: {e} - Retrying...")
            raise

    # --- æ³›å‹æ–¹æ³•ï¼šç›´æ¥è¿”å› Pydantic å¯¹è±¡ ---
    def request_model(self, method: str, endpoint: str, response_model: Type[T], **kwargs) -> T:
        data = self._request(method, endpoint, **kwargs)
        # Pydantic V2 è¯­æ³•
        return response_model.model_validate(data)

    def close(self):
        self.client.close()
```

---

### 4. ä¸šåŠ¡æ¥å£å±‚ (`client/services/*.py`)

**ä½œç”¨**: æŒ‰ä¸šåŠ¡é¢†åŸŸç»„ç»‡æ¥å£ï¼Œåªå…³æ³¨ Endpoint å’Œæ¨¡å‹è½¬æ¢ï¼Œä¸å…³å¿ƒåº•å±‚ HTTP ç»†èŠ‚ã€‚

**`client/services/user.py`**

```python
from client.core import BaseClient
from schemas import UserDTO, CreateUserRequest, UserListDTO

class UserService(BaseClient):
    
    def get_user(self, user_id: int) -> UserDTO:
        """è·å–å•ä¸ªç”¨æˆ·ï¼Œè¿”å›å¼ºç±»å‹å¯¹è±¡"""
        return self.request_model(
            "GET", 
            f"/users/{user_id}", 
            response_model=UserDTO
        )

    def create_user(self, body: CreateUserRequest) -> UserDTO:
        """åˆ›å»ºç”¨æˆ·ï¼Œå…¥å‚ä¹Ÿæ˜¯ Pydantic å¯¹è±¡"""
        return self.request_model(
            "POST", 
            "/users", 
            response_model=UserDTO,
            json=body.model_dump() # è½¬ä¸ºå­—å…¸
        )
```

**`client/services/order.py`**

```python
from client.core import BaseClient

class OrderService(BaseClient):
    def get_orders(self, page: int = 1):
        # ç®€å•æ¥å£ä¹Ÿå¯ä»¥ä¸å®šä¹‰ Modelï¼Œç›´æ¥è¿”å› dict
        return self._request("GET", "/orders", params={"page": page})
```

---

### 5. ç»Ÿä¸€å…¥å£ä¸å•ä¾‹ (`client/__init__.py`)

**ä½œç”¨**: é—¨é¢æ¨¡å¼ (Facade)ï¼Œå¤–éƒ¨åªéœ€è¦å¼•å…¥è¿™ä¸€ä¸ªç±»ã€‚

```python
from client.services.user import UserService
from client.services.order import OrderService

class ThirdPartyAPI:
    def __init__(self):
        # ç»„åˆæ¨¡å¼ï¼šå°†å„ä¸ª Service æŒ‚è½½åˆ°ä¸»ç±»
        # æ³¨æ„ï¼šè¿™é‡Œå„ä¸ª Service å¯èƒ½ä¼šå…±äº«åŒä¸€ä¸ª httpx.Client å®ä¾‹ä»¥å¤ç”¨è¿æ¥æ± 
        # ä¸ºç®€å•èµ·è§ï¼Œè¿™é‡Œé€šè¿‡ç»§æ‰¿åˆ†åˆ«å®ä¾‹åŒ–ï¼Œå®é™…ä¼˜åŒ–å¯ä¼ å…¥ shared_client
        self.user = UserService()
        self.order = OrderService()

    def close(self):
        self.user.close()
        self.order.close()

# å•ä¾‹å®ä¾‹
api = ThirdPartyAPI()
```

---

### 6. ä½¿ç”¨ç¤ºä¾‹ (`main.py`)

è¿™å°±æ˜¯æœ€ç»ˆåœ¨ä¸šåŠ¡é€»è¾‘ä¸­è°ƒç”¨çš„æ ·å­ï¼š**æ¸…æ™°ã€æœ‰ç±»å‹æç¤ºã€è‡ªåŠ¨é‡è¯•ã€è‡ªåŠ¨æ—¥å¿—**ã€‚

```python
import sys
from loguru import logger
from client import api
from schemas import CreateUserRequest

# é…ç½® Loguru æ ¼å¼
logger.remove()
logger.add(sys.stderr, format="<green>{time:HH:mm:ss}</green> | <level>{level}</level> | {message}")

def main
        # 1. ç®€å•æŸ¥è¯¢
        logger.info("Starting user fetch...")
        user = api.user.get_user(user_id=101)
        # IDE ä¼šåœ¨è¿™é‡Œæç¤º user å¯¹è±¡çš„å±æ€§ (.username, .email)
        print(f"Got user: {user.username}")

        # 2. åˆ›å»ºæ“ä½œ (å¸¦å‚æ•°æ ¡éªŒ)
        new_user = CreateUserRequest(username="test_dev", password="secret_password")
        created = api.user.create_user(new_user)
        print(f"Created user id: {created.id}")

    except Exception as e:
        logger.exception("Business logic failed")
    finally:
        api.close()

if __name__ == "__main__":
    main()
```

---

### ğŸš€ ä¸ºä»€ä¹ˆè¿™æ˜¯â€œæœ€ä½³å®è·µâ€ï¼Ÿ

1. **Httpx**: æ¯”å¦‚ `requests` æ›´ç°ä»£åŒ–ï¼ŒåŸç”Ÿæ”¯æŒ `async`ï¼ˆè¿™å¥—ä»£ç ç¨å¾®æ”¹æ”¹å°±èƒ½å˜æˆå¼‚æ­¥ï¼‰ï¼Œæ”¯æŒ HTTP/2ã€‚
2. **Pydantic**:
    * **In**: ä¿è¯ä½ å‘ç»™å¯¹æ–¹çš„æ•°æ®æ˜¯åˆæ³•çš„ï¼ˆæ¯”å¦‚ `username` ä¸èƒ½ä¸ºç©ºï¼‰ã€‚
    * **Out**: ä¿è¯å¯¹æ–¹è¿”å›çš„æ•°æ®ç»“æ„æ˜¯ä½ é¢„æœŸçš„ï¼Œä¸”è®© IDE èƒ½è‡ªåŠ¨è¡¥å…¨å­—æ®µï¼Œä¸å†éœ€è¦çŒœå­—å…¸é‡Œçš„ Keyã€‚
    * **Settings**: å°†é…ç½®ä¸ä»£ç è§£è€¦ï¼Œç¬¦åˆ [12-Factor App](https://12factor.net/) åŸåˆ™ã€‚
3. **Tenacity**: ç½‘ç»œæŠ–åŠ¨æ˜¯å¸¸æ€ã€‚æŠŠé‡è¯•é€»è¾‘ç”¨ `@retry` è£…é¥°å™¨å†™åœ¨åº•å±‚ï¼Œä¸šåŠ¡ä»£ç ä¸éœ€è¦å†™æ»¡ `try-except` å¾ªç¯ã€‚
4. **Loguru**: æå…¶ä¼˜é›…çš„æ—¥å¿—åº“ï¼Œä¸å†éœ€è¦å¤æ‚çš„ logging é…ç½®ï¼Œé…åˆåº•å±‚æ‹¦æˆªï¼Œèƒ½è‡ªåŠ¨è®°å½•æ¯ä¸€æ¬¡å¤–éƒ¨äº¤äº’ï¼Œæ’æŸ¥ Bug ç¥å™¨ã€‚
5. **ç»“æ„åˆ†å±‚**:
    * `Settings` ç®¡é…ç½®ã€‚
    * `Schemas` ç®¡æ•°æ®æ ¼å¼ã€‚
    * `Core` ç®¡ HTTP åè®®ç»†èŠ‚ã€‚
    * `Service` ç®¡ä¸šåŠ¡æ¥å£ã€‚
    * **ä¿®æ”¹ä»»ä½•ä¸€å±‚éƒ½ä¸ä¼šå½±å“å…¶ä»–å±‚ã€‚**
