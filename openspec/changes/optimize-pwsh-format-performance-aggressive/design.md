## Context

当前 `format:pwsh` 通过 `pwsh -File` 调用格式化脚本，脚本内部在每次执行都先做模块可用性全量扫描，再执行 Git 改动判定。实测表明：

- 空改动场景仍有明显固定耗时，影响提交前快速反馈。
- 默认 `Invoke-Formatter` 规则集在部分文件上存在数十秒级长尾。
- 目录扫描与文件写回路径存在额外 IO 成本。

该变更目标是“本地开发优先速度”，允许在默认链路牺牲部分格式严格性，并通过显式“严格模式”保留完整行为。

## Goals / Non-Goals

**Goals:**
- 将空改动 `format:pwsh` 耗时降到亚秒级到低秒级范围。
- 将常见少量改动场景耗时显著降低，消除数十秒级长尾。
- 保持现有命令入口稳定，新增可选严格模式以便需要时使用完整规则。

**Non-Goals:**
- 不追求与历史默认 `Invoke-Formatter` 输出逐字节一致。
- 不在此次变更中引入新的第三方格式化工具。
- 不重构与 PowerShell 格式化无关的测试或业务脚本。

## Decisions

- **默认改为快速路径（激进）**
  - 做法：`-GitChanged` 先计算改动列表；为空直接返回，不再加载 `PSScriptAnalyzer`。
  - 原因：空改动是高频场景，尽早返回收益最大。
  - 备选：维持先加载模块再判定改动；被否决，因固定开销不可接受。

- **移除模块预扫描，改为惰性加载**
  - 做法：取消 `Get-Module -ListAvailable` 预检查，直接 `Import-Module`，失败后给出安装指引/按现有策略安装。
  - 原因：预扫描比导入本身更慢，属于纯前置成本。
  - 备选：缓存扫描结果；被否决，复杂度高且跨会话收益有限。

- **引入激进 formatter 规则集（默认）**
  - 做法：提供明确 settings，排除高耗时规则 `PSUseCorrectCasing`，保留核心排版规则（缩进、空白、括号布局等）。
  - 原因：单规则开销差异极大，禁用该规则能显著削减长尾。
  - 备选：维持默认全规则；被否决，无法满足性能目标。

- **保留严格模式作为逃生阀**
  - 做法：新增脚本参数或 npm 子命令（如 `format:pwsh:strict`）启用完整规则集。
  - 原因：在 CI 或发布前仍可获得完整一致性校验。
  - 备选：仅保留激进模式；被否决，风险不可控。

- **降低启动与 IO 开销**
  - 做法：npm 脚本默认使用 `pwsh -NoProfile`；目录扫描改为单次遍历按扩展名过滤；格式化前后一致时跳过写盘。
  - 原因：启动/遍历/写盘均是可叠加的非业务成本。
  - 备选：仅优化单点；被否决，整体收益不足。

## Risks / Trade-offs

- **格式严格性下降（特别是大小写规范）** → 通过 `strict` 模式补齐，并在文档中明确两种模式适用场景。
- **开发与 CI 输出不一致** → 约定 CI 使用严格模式，或在发布前执行一次严格格式化。
- **参数分叉增加维护成本** → 仅保留两档模式（fast/strict），避免更多组合。
- **对现有开发习惯有迁移成本** → 在 README 与命令说明里给出简明迁移指南。

## Migration Plan

1. 先在脚本中加入新参数与默认快速路径，不移除旧入口。
2. 更新 `package.json`：默认命令走快速模式，新增严格模式命令。
3. 更新文档并在团队内公告：日常用快速模式，发布前/CI 用严格模式。
4. 观察一轮实际提交反馈，如有争议再微调规则集。

## Open Questions

- CI 默认是否立即切到严格模式，还是先保持现状并新增独立命令？
- `PSUseCorrectCasing` 是否需要仅在严格模式启用，还是拆到独立校验脚本？

## Performance Baseline / After

测试日期：2026-02-11

测试口径：
- 空改动：`pnpm format:pwsh`（无 PowerShell 改动）
- 少量改动：对 `config/software/gitea/__sync.ps1` 注入一个换行后执行 `pnpm format:pwsh`
- 重文件场景：复制 `psutils/modules/help.psm1` 到临时文件并执行
  `pwsh -NoProfile -File ./scripts/pwsh/devops/Format-PowerShellCode.ps1 -Path <temp-file>`

| 场景 | 变更前 | 变更后 | 提升 |
| --- | ---: | ---: | ---: |
| 空改动 | 8.631s | 1.827s | 78.8% |
| 少量改动 | 8.580s | 1.652s | 80.7% |
| 重文件 | 42.379s | 0.854s | 98.0% |
