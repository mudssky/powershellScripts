# PromptOps：Prompt 版本管理与发布

Prompt 是“可执行配置”，一旦进入生产环境，就需要像代码一样被版本化、评估、灰度与回滚。

**1. Prompt-as-Code（把 Prompt 当代码）**

* **目录化**：按“场景/任务”拆分文件，避免把所有指令堆在一个长字符串里。
* **模板化**：把可变部分显式参数化（用户画像、语言、语气、上下文片段），避免隐式拼接导致不可控。
* **元数据固化**：每个 Prompt 变体都绑定一份元数据：`prompt_id`、版本号、模型与采样参数、工具列表/Schema、上下文预算（token budget）、知识库版本/索引版本。
* **可追溯**：线上日志必须能定位到“用的是哪个 `prompt_id@version`”，否则无法做回归与复盘。

**2. 版本与实验（Variant/A-B/灰度）**

* **稳定标识**：用 `prompt_id` 表示“同一能力”，用 `variant` 表示“不同写法/策略”，用版本号表示“可回滚的发布单元”。
* **灰度优先**：新版本先小流量发布，监控质量指标与成本/延迟，再逐步放量。
* **实验分层**：先离线评估（回归集）再线上 A/B；不要用线上用户当唯一测试集。

**3. 回归测试与评估门禁（Prompt 改动必评估）**

* **Golden Dataset**：为每个核心能力维护一组最小回归集（例如 50-200 条），覆盖边界条件与已知故障样例。
* **多维度指标**：格式合规（JSON/Schema）、事实准确、引用是否可追溯、拒答是否合理、有害性、成本与延迟。
* **非确定性处理**：评估时固定采样策略（温度、top_p），必要时对同一用例做多次采样取分位数/均值，避免偶然波动。

**4. 发布与回滚（让 Prompt 具备工程化发布能力）**

* **配置分离**：Prompt 内容、模型参数、路由策略、工具开关、知识库索引版本应可独立变更并可回滚。
* **Feature Flag**：用开关控制变体启用范围（租户/用户分组/场景），支持秒级回滚。
* **变更记录**：为 Prompt 维护最小 changelog：改了什么、影响哪些场景、对应评估结果与上线时间。

## 相关工具链接

- Prompt 测试/回归：<https://github.com/promptfoo/promptfoo>
- Prompt 流水线与实验：<https://github.com/microsoft/promptflow>
- Trace + Prompt 版本/配置联动：<https://github.com/langfuse/langfuse>
- Prompt 管理（SaaS/自建方案之一）：<https://github.com/promptlayer/promptlayer>
