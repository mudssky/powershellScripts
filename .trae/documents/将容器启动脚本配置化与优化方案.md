## 目标与原则
- 解耦：服务定义放入配置文件，脚本仅负责解析、校验与拼接命令
- 可扩展：新增/修改服务不改脚本逻辑，改配置即可
- 可观测：清晰输出、健壮错误处理、支持 Dry-Run 预览命令
- 跨平台：Windows/macOS/Linux 路径与参数一致性

## 配置文件设计
- 位置：`c:/home/env/powershellScripts/config/containers.json`（新增脚本参数 `-ConfigPath` 覆盖）
- 结构：`defaults` + `aliases` + `services`
- 占位符：支持 `${DataPath}`、`${DefaultUser}`、`${DefaultPassword}`、`${RestartPolicy}` 等模板变量
- 字段：
  - `image`、`name`、`ports[]`、`volumes[]`、`env{}`、`restartPolicy`
  - `healthcheck{cmd,interval,timeout,retries}`
  - `log{driver,maxSize,maxFile}`、`network`、`labels{}`
  - `gpus`、`privileged`、`devices[]`、`shmSize`、`extraArgs[]`
  - `compose`、`composeFile`、`composeProject`
- 示例：
```json
{
  "defaults": {
    "restartPolicy": "unless-stopped",
    "dataPath": "C:/docker_data",
    "log": { "driver": "json-file", "maxSize": "10m", "maxFile": 3 },
    "network": null
  },
  "aliases": { "postgre": "postgres" },
  "services": {
    "redis": {
      "image": "redis:latest",
      "name": "redis-dev",
      "ports": ["6379:6379"],
      "env": {},
      "volumes": []
    },
    "postgres": {
      "image": "postgres:latest",
      "name": "postgre-dev",
      "ports": ["5432:5432"],
      "env": { "POSTGRES_PASSWORD": "${DefaultPassword}", "TZ": "Asia/Shanghai" },
      "volumes": ["${DataPath}/postgresql/data:/var/lib/postgresql/data"],
      "healthcheck": { "cmd": "pg_isready -U postgres", "interval": "10s", "timeout": "5s", "retries": 3 }
    },
    "minio": {
      "image": "bitnami/minio:latest",
      "name": "minio-dev",
      "ports": ["9000:9000", "9001:9001"],
      "env": { "MINIO_ROOT_USER": "${DefaultUser}", "MINIO_ROOT_PASSWORD": "${DefaultPassword}" },
      "volumes": ["${DataPath}/minio:/bitnami/minio/data"]
    },
    "mongodb": {
      "image": "mongo:8",
      "name": "mongodb-dev",
      "ports": ["27017:27017"],
      "volumes": ["${DataPath}/mongodb:/data/db"]
    },
    "mongodb-replica": {
      "compose": true,
      "composeFile": "dockerfiles/compose/mongo-repl.compose.yml",
      "composeProject": "mongo-repl-dev",
      "env": { "DOCKER_DATA_PATH": "${DataPath}", "MONGO_USER": "${DefaultUser}", "MONGO_PASSWORD": "${DefaultPassword}" }
    },
    "cadvisor": {
      "image": "gcr.io/cadvisor/cadvisor:latest",
      "name": "cadvisor-dev",
      "ports": ["38181:8080"],
      "volumes": ["/:/rootfs:ro","/var/run:/var/run:ro","/sys:/sys:ro","/var/lib/docker/:/var/lib/docker:ro","/dev/disk/:/dev/disk:ro"],
      "privileged": true,
      "devices": ["/dev/kmsg"]
    }
  }
}
```

## 脚本改造（函数与流程）
- 新增参数：`-ConfigPath`、`-ServiceName`、`-RestartPolicy`、`-DataPath`、`-DefaultUser`、`-DefaultPassword`、`-DryRun`、`-PullLatest`、`-Profile`
- `Load-ContainerConfig`：读取 JSON 并做 schema 校验；应用 `aliases`
- `Resolve-Template`：对服务对象进行模板变量展开（参数 > 环境变量 > defaults）
- `Ensure-HostVolumes`：从 `volumes` 抽取宿主机路径并创建目录（幂等）
- `Build-DockerRunArgs`：把服务配置转为 `docker run` 参数数组（含日志、网络、健康检查、设备、shm、extraArgs）
- `Invoke-DockerRun`：支持 `-DryRun` 输出最终命令；`-PullLatest` 时先 `docker pull`
- `Invoke-DockerComposeUp`：当 `compose=true` 时用 `docker compose -p <project> -f <file> up -d`，并注入 `env`
- 网络：若 `defaults.network` 设置则确保存在并自动附加
- 错误处理：`try/catch`、`Write-Error`，并在失败时输出建议与上下文
- 兼容：当配置不存在该服务时，回退到现有 `switch ($ServiceName)` 分支启动
- 幂等：同名容器已存在时提示并支持 `--restart`/`docker start` 路径

## 与现有脚本的兼容与修复
- 保留 `postgre` 名称作为别名映射到 `postgres`
- `cadvisor` 的 `$VERSION` 改为配置化（如 `latest`），避免未定义变量
- 统一日志参数通过 `defaults.log` 注入，而非硬编码在多处
- 路径统一使用 `/` 或 `Join-Path` 规范化，减少平台差异

## 进一步优化清单
- 健壮性：
  - `Test-DockerInstalled` 与 `docker info` 预检
  - 检查镜像是否存在，不存在时自动拉取（配合 `-PullLatest`）
- 可观测性：
  - 启动后输出访问 URL、端口、默认凭据与容器名称
  - 为容器加 `--label`（如 `app=<service>`、`env=dev`）便于筛选
- 安全：
  - 支持 `.env` 文件注入敏感信息，避免明文放在配置
  - 可选 `Read-Host -AsSecureString` 输入密码
- 性能与体验：
  - `-DryRun` 预览拼接的完整命令，便于审查
  - `-ListServices` 列出配置内所有服务；`-Describe <name>` 输出该服务详情
- 测试：
  - Pester 用例覆盖：模板替换、目录创建、命令构建、Compose 分支与错误路径
- GPU/设备：
  - Windows 无 GPU 时自动忽略 `--gpus all`（由配置控制）

## 交付物
- 新增：`config/containers.json`（或改为 YAML 亦可）
- 更新：`start-container.ps1` 重构为配置驱动启动
- 可选：`tests/Start-Container.Tests.ps1`（Pester）

## 下一步执行顺序
1. 定义 JSON Schema 与示例配置（覆盖现有所有服务）
2. 实现配置加载与模板变量解析
3. 抽象命令构建器并接入 `docker run`/`docker compose`
4. 目录预创建、网络与日志参数的统一注入
5. 加回退逻辑以兼容当前 `switch` 分支
6. 编写基础 Pester 测试与帮助注释（.SYNOPSIS/.PARAMETER/.EXAMPLE）
